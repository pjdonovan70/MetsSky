<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>MetsSky | The Dynasty</title>
    <meta name="description" content="The ultimate hub for NY Mets fans.">
    
    <meta name="theme-color" content="#002D72">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MetsSky">

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; background-image: radial-gradient(at 0% 0%, #002D72 0, transparent 50%), radial-gradient(at 100% 100%, #FF5910 0, transparent 50%); background-attachment: fixed; overscroll-behavior-y: none; }
        .glass-panel { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .pulse-dot { animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); } 100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); } }
        .chat-anim { animation: slide-up 0.3s ease-out; }
        @keyframes slide-up { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="text-slate-200 font-sans selection:bg-orange-500/30">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const formatDate = (d) => { if(!d) return ''; try { const date = new Date(d); if(isNaN(date.getTime())) return ''; return date.toLocaleDateString(undefined, {year:'numeric',month:'short',day:'numeric'}); } catch(e){return '';} };
        
        // --- ICONS ---
        const Icons = {
            Home: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
            Trash2: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Link: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
            RefreshCw: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
            Calendar: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
            X: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Users: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            ClipboardList: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>,
            Tv: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="20" height="15" x="2" y="7" rx="2" ry="2"/><polyline points="17 2 12 7 7 2"/></svg>,
            Play: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none" className={className}><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            MessageSquare: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
            Edit2: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
            FileText: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>,
            Send: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            Minimize2: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="4 14 10 14 10 20"/><polyline points="20 10 14 10 14 4"/><line x1="14" y1="10" x2="21" y2="3"/><line x1="3" y1="21" x2="10" y2="14"/></svg>,
            Cloud: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5c-1.45 0-2.748.59-3.714 1.541A5.496 5.496 0 0 0 6 13.5A5.506 5.506 0 0 0 11.5 19h6Z"/><path d="M17.5 19c2.485 0 4.5-2.015 4.5-4.5S19.985 10 17.5 10c-.16 0-.317.009-.471.025A5.5 5.5 0 0 0 12 5c-2.598 0-4.766 1.814-5.316 4.233A5.503 5.503 0 0 0 2 13.5C2 16.537 4.463 19 7.5 19h10Z"/></svg>,
            ArrowUpCircle: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="m16 12-4-4-4 4"/><path d="M12 16V8"/></svg>,
            ArrowDownCircle: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="m16 12-4 4-4-4"/><path d="M12 8v8"/></svg>,
            Newspaper: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"/><path d="M18 14h-8"/><path d="M15 18h-5"/><path d="M10 6h8v4h-8V6Z"/></svg>,
            LogOut: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            BookOpen: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
            Mail: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>,
            Lock: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            User: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Briefcase: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
            Activity: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>,
            Shuffle: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 18h1.4c1.3 0 2.5-.6 3.3-1.7l14.2-17"/><path d="M2 5h1.4c1.3 0 2.5.6 3.3 1.7l14.2 17"/></svg>,
            Camera: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
        };

        const firebaseConfig = {
            apiKey: "AIzaSyAkDUZZnh_AoKhBe-ntB1I4-QJKyiaEeg8",
            authDomain: "rollcall-e5e3a.firebaseapp.com",
            projectId: "rollcall-e5e3a",
            storageBucket: "rollcall-e5e3a.firebasestorage.app",
            messagingSenderId: "301776745476",
            appId: "1:301776745476:web:49d23434d590135c7df151"
        };

        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();
        
        db.enablePersistence().catch(err => {
            if (err.code == 'failed-precondition') { console.log("Persistence failed: Multiple tabs open."); } 
            else if (err.code == 'unimplemented') { console.log("Persistence not supported by browser."); }
        });

        // --- COMPONENTS ---

        const Avatar = ({ src, name, className }) => {
            const [error, setError] = useState(false);
            if (src && !error) {
                return <img src={src} className={className} onError={() => setError(true)} alt={name} />;
            }
            return (
                <div className={`${className} bg-slate-700 flex items-center justify-center text-white font-bold border border-white/10 uppercase`}>
                    {name ? name[0] : '?'}
                </div>
            );
        };

        const UserLink = ({ uid, name, photoURL, children, className }) => {
            const handleClick = (e) => {
                if (uid) {
                    e.stopPropagation();
                    window.location.hash = `profile/${uid}`;
                }
            };
            return (
                <div onClick={handleClick} className={`cursor-pointer hover:opacity-80 transition-opacity flex items-center gap-2 ${className}`}>
                    {children}
                </div>
            );
        };

        // Missing Component Definitions (Mocked/Basic implementations to prevent errors)
        const CountdownTicket = () => <div className="hidden"></div>;
        const NewsBoard = ({news}) => <div className="text-white text-center">News Feed</div>;
        const MediaBoard = () => <div className="text-white text-center">Media</div>;
        const ScheduleCard = ({game}) => <div className="text-white p-4 border border-white/10">{game.date}</div>;
        const RosterBoard = () => <div className="text-white text-center">Roster</div>;
        const MovesBoard = () => <div className="text-white text-center">Moves</div>;
        const LinksBoard = () => <div className="text-white text-center">Links</div>;
        const RandomSeriesBoard = () => <div className="text-white text-center">Random Series</div>;
        const HomeFloatingButton = () => null;
        const AuthGate = () => <div className="text-white text-center">Login Required</div>;
        const RandomMetRibbon = () => null; 

        // --- FEATURED VIDEO COMPONENT (2025 Mets Theme Song) ---
        const FeaturedVideo = () => (
            <div className="glass-panel p-6 rounded-3xl border border-white/10 relative overflow-hidden group mb-8">
                <div className="absolute inset-0 bg-gradient-to-r from-orange-600/10 to-blue-600/10 opacity-50"></div>
                <div className="relative z-10">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-xl font-black text-white italic tracking-tighter flex items-center gap-2">
                            <Icons.Play className="w-6 h-6 text-orange-500"/> 
                            2025 Mets Theme Song
                        </h3>
                        <div className="bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded uppercase tracking-widest animate-pulse">
                            Featured
                        </div>
                    </div>
                    <div className="aspect-video w-full rounded-2xl overflow-hidden shadow-2xl border border-white/10 bg-black">
                        <iframe 
                            className="w-full h-full" 
                            src="https://www.youtube.com/embed/hQ-sWvGg2MI" 
                            title="Mets Theme" 
                            frameBorder="0" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowFullScreen
                        ></iframe>
                    </div>
                </div>
            </div>
        );

        const MembersBoard = () => {
            const [members, setMembers] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const unsubscribe = db.collection('users').orderBy('createdAt', 'desc').limit(100).onSnapshot(snapshot => {
                    const data = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    setMembers(data);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            if (loading) return <div className="text-center text-slate-500 py-10">Scouting the roster...</div>;

            return (
                <div className="space-y-6 animate-fade-in">
                    <h2 className="text-2xl font-black text-white flex items-center gap-2"><Icons.Users className="w-6 h-6 text-blue-500"/> MetsSky Roster</h2>
                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        {members.map(member => (
                            <div key={member.id} onClick={() => window.location.hash = `profile/${member.id}`} className="glass-panel p-4 rounded-2xl border border-white/10 hover:bg-white/5 transition-all cursor-pointer group flex items-center gap-4">
                                <Avatar src={member.photoURL} name={member.displayName} className="w-12 h-12 rounded-full border border-white/10" />
                                <div className="min-w-0">
                                    <div className="font-bold text-white group-hover:text-blue-400 transition-colors truncate">{member.displayName || 'Fan'}</div>
                                    <div className="text-xs text-slate-500">Joined {member.createdAt ? new Date(member.createdAt.seconds * 1000).toLocaleDateString() : 'Recently'}</div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const ProfileBoard = ({ currentUser, viewUserId, onUpdateProfile, onLogout }) => {
            const [displayUser, setDisplayUser] = useState(null);
            const [isEditing, setIsEditing] = useState(false);
            const [tempName, setTempName] = useState('');
            const [tempBio, setTempBio] = useState('');
            const [imageFile, setImageFile] = useState(null);
            const [isSaving, setIsSaving] = useState(false);
            
            const isOwnProfile = currentUser && (viewUserId === currentUser.uid || !viewUserId);

            useEffect(() => {
                const targetId = viewUserId || (currentUser ? currentUser.uid : null);
                if (!targetId) return;

                if (isOwnProfile && currentUser) {
                    // Load own profile with realtime updates
                    const unsubscribe = db.collection('users').doc(currentUser.uid).onSnapshot(doc => {
                        if (doc.exists) {
                            const data = doc.data();
                            setDisplayUser(data);
                            if (!isEditing) {
                                setTempName(data.displayName || currentUser.displayName || '');
                                setTempBio(data.bio || '');
                            }
                        } else {
                            // Fallback for new users
                            setDisplayUser({ displayName: currentUser.displayName, email: currentUser.email, photoURL: currentUser.photoURL });
                            setTempName(currentUser.displayName || '');
                        }
                    });
                    return () => unsubscribe();
                } else {
                    // Load other user profile
                    db.collection('users').doc(targetId).get().then(doc => {
                        if (doc.exists) setDisplayUser(doc.data());
                    });
                }
            }, [viewUserId, currentUser, isEditing]);

            const handleSave = async (e) => {
                e.preventDefault();
                setIsSaving(true);
                try {
                    let photoURL = currentUser.photoURL;
                    if(imageFile) {
                        const ref = storage.ref(`users/${currentUser.uid}/${Date.now()}_avatar`);
                        await ref.put(imageFile);
                        photoURL = await ref.getDownloadURL();
                    }

                    // 1. Update Auth Profile
                    if (auth.currentUser) {
                        await auth.currentUser.updateProfile({ displayName: tempName, photoURL: photoURL });
                    }
                    
                    // 2. Update Firestore
                    await db.collection('users').doc(currentUser.uid).set({
                        displayName: tempName,
                        photoURL: photoURL,
                        bio: tempBio,
                        email: currentUser.email,
                        lastActive: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });

                    // 3. Update App State (Safe)
                    if (onUpdateProfile) onUpdateProfile();

                    setIsEditing(false);
                    setImageFile(null);
                } catch(err) {
                    console.error(err);
                    alert("Error saving: " + err.message);
                }
                setIsSaving(false);
            };

            if (!displayUser) return <div className="text-center text-slate-500 py-20">Loading Player Card...</div>;

            return (
                <div className="animate-fade-in max-w-2xl mx-auto">
                    <div className="glass-panel p-8 rounded-3xl border border-white/10 relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-32 bg-gradient-to-r from-orange-600 to-blue-600 opacity-20"></div>
                        
                        <div className="relative z-10 flex flex-col items-center">
                            <div className="w-32 h-32 rounded-full border-4 border-slate-900 shadow-2xl overflow-hidden mb-4 bg-slate-800">
                                <Avatar src={displayUser.photoURL} name={displayUser.displayName} className="w-full h-full object-cover" />
                            </div>
                            
                            {!isEditing ? (
                                <div className="text-center space-y-2 mb-8 w-full">
                                    <h2 className="text-3xl font-black text-white">{displayUser.displayName || 'Fan'}</h2>
                                    {isOwnProfile && <div className="text-sm text-slate-400 font-bold">{displayUser.email}</div>}
                                    <div className="mt-6 p-6 bg-white/5 rounded-2xl border border-white/5 mx-auto max-w-md">
                                        <h4 className="text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Scouting Report</h4>
                                        <p className="text-slate-200 italic leading-relaxed">"{displayUser.bio || 'No bio available.'}"</p>
                                    </div>
                                    
                                    {isOwnProfile && (
                                        <div className="flex gap-4 justify-center mt-8">
                                            <button onClick={() => setIsEditing(true)} className="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-xl font-bold flex items-center gap-2 transition-colors">
                                                <Icons.Edit2 className="w-4 h-4" /> Edit Profile
                                            </button>
                                            <button onClick={onLogout} className="bg-slate-800 hover:bg-red-900/50 text-slate-300 hover:text-red-400 px-6 py-2 rounded-xl font-bold flex items-center gap-2 transition-colors border border-white/10">
                                                <Icons.LogOut className="w-4 h-4" /> Sign Out
                                            </button>
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <form onSubmit={handleSave} className="w-full max-w-md space-y-4">
                                    <div>
                                        <label className="text-[10px] uppercase font-bold text-slate-500">Profile Photo</label>
                                        <input type="file" accept="image/*" onChange={e => setImageFile(e.target.files[0])} className="w-full bg-slate-900/50 border border-white/10 rounded-xl p-3 text-white text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-orange-600 file:text-white hover:file:bg-orange-500"/>
                                    </div>
                                    <div>
                                        <label className="text-[10px] uppercase font-bold text-slate-500">Display Name</label>
                                        <input type="text" value={tempName} onChange={e => setTempName(e.target.value)} className="w-full bg-slate-900/50 border border-white/10 rounded-xl p-3 text-white focus:outline-none focus:border-blue-500 font-bold" required />
                                    </div>
                                    <div>
                                        <label className="text-[10px] uppercase font-bold text-slate-500">About Me / Bio</label>
                                        <textarea value={tempBio} onChange={e => setTempBio(e.target.value)} className="w-full h-32 bg-slate-900/50 border border-white/10 rounded-xl p-3 text-white focus:outline-none focus:border-blue-500" placeholder="LGM Since..." />
                                    </div>
                                    <div className="flex gap-3 pt-2">
                                        <button type="submit" disabled={isSaving} className="flex-1 bg-green-600 hover:bg-green-500 text-white py-3 rounded-xl font-bold shadow-lg disabled:opacity-50">
                                            {isSaving ? 'Saving...' : 'Save Changes'}
                                        </button>
                                        <button type="button" onClick={() => { setIsEditing(false); setImageFile(null); }} className="px-6 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-bold">
                                            Cancel
                                        </button>
                                    </div>
                                </form>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const CommentsSection = ({ postId, currentUser }) => {
            const [comments, setComments] = useState([]); 
            const [text, setText] = useState('');
            useEffect(() => { 
                if(!postId) return; 
                const unsubscribe = db.collection('mets_comments').where('postId', '==', postId).onSnapshot(s => { 
                    const d = s.docs.map(x=>({id:x.id,...x.data()})); 
                    d.sort((a,b)=>(a.createdAt?.seconds||0)-(b.createdAt?.seconds||0)); 
                    setComments(d); 
                }); 
                return () => unsubscribe(); 
            }, [postId]);
            const post = async (e) => { 
                e.preventDefault(); 
                if(!text.trim() || !currentUser) return; 
                await db.collection('mets_comments').add({ 
                    postId, 
                    text, 
                    authorName: currentUser.displayName || 'Fan', 
                    authorId: currentUser.uid, 
                    authorPhoto: currentUser.photoURL || null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp() 
                }); 
                setText(''); 
            };
            return ( 
                <div className="mt-4 pt-4 border-t border-white/5 bg-black/20 p-4 rounded-xl animate-fade-in"> 
                    <h5 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">Comments ({comments.length})</h5> 
                    <div className="space-y-3 mb-4 max-h-60 overflow-y-auto custom-scrollbar"> 
                        {comments.map(c => ( 
                            <div key={c.id} className="bg-slate-800/50 p-3 rounded-lg border border-white/5 flex gap-3"> 
                                <UserLink uid={c.authorId} className="shrink-0">
                                    <Avatar src={c.authorPhoto} name={c.authorName} className="w-8 h-8 rounded-full object-cover border border-white/10" />
                                </UserLink>
                                <div className="flex-1 min-w-0">
                                    <div className="flex justify-between items-start"> 
                                        <UserLink uid={c.authorId}><span className="text-[10px] font-bold text-blue-400 hover:text-white transition-colors">{c.authorName}</span></UserLink>
                                        <span className="text-[10px] text-slate-600">{c.createdAt ? new Date(c.createdAt.seconds * 1000).toLocaleDateString() : 'Just now'}</span> 
                                    </div> 
                                    <div className="text-sm text-slate-200 mt-1 break-words">{c.text}</div> 
                                </div>
                            </div> 
                        ))} 
                        {comments.length === 0 && <div className="text-center text-slate-600 text-xs italic py-2">No comments yet.</div>} 
                    </div> 
                    {currentUser ? ( 
                        <form onSubmit={post} className="flex gap-2"> 
                            <input type="text" placeholder="Write a comment..." className="flex-1 bg-slate-900 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500" value={text} onChange={e => setText(e.target.value)} /> 
                            <button type="submit" className="bg-blue-600 hover:bg-blue-500 text-white p-2 rounded-lg"><Icons.Send className="w-4 h-4"/></button> 
                        </form> 
                    ) : <div className="text-center text-xs text-slate-500 italic">Sign in to comment.</div>} 
                </div> 
            );
        };

        const RantCard = ({ rant, currentUser, onDelete }) => {
            const [showComments, setShowComments] = useState(false);
            return (
                <div className="glass-panel p-6 rounded-3xl border border-white/5 hover:border-red-500/30 transition-all relative group">
                    <div className="flex justify-between items-start mb-4">
                        <div className="flex items-center gap-3">
                            <UserLink uid={rant.authorId}>
                                <Avatar src={rant.authorPhoto} name={rant.authorName} className="w-10 h-10 rounded-full border border-white/10 object-cover" />
                            </UserLink>
                            <div>
                                <UserLink uid={rant.authorId}>
                                    <div className="font-bold text-white text-sm hover:text-blue-400 transition-colors">{rant.authorName}</div>
                                </UserLink>
                                <div className="text-[10px] text-slate-500 uppercase tracking-widest">{rant.mood} ‚Ä¢ {rant.createdAt ? new Date(rant.createdAt.seconds * 1000).toLocaleDateString() : 'Just Now'}</div>
                            </div>
                        </div>
                        {currentUser && currentUser.uid === rant.authorId && (
                            <button onClick={() => onDelete(rant.id)} className="text-slate-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><Icons.Trash2 className="w-4 h-4"/></button>
                        )}
                    </div>
                    <h4 className="font-black text-white text-lg mb-2">{rant.topic}</h4>
                    <p className="text-slate-300 text-sm leading-relaxed whitespace-pre-wrap">{rant.content}</p>
                    <div className="mt-4 pt-4 border-t border-white/5">
                        <button onClick={() => setShowComments(!showComments)} className="flex items-center gap-2 text-xs font-bold text-slate-400 hover:text-white transition-colors">
                            <Icons.MessageSquare className="w-4 h-4"/> {showComments ? 'Hide Comments' : 'Reply / View Comments'}
                        </button>
                    </div>
                    {showComments && <CommentsSection postId={rant.id} currentUser={currentUser} />}
                </div>
            );
        };

        const ChatBox = ({ currentUser }) => {
            const [isOpen, setIsOpen] = useState(false); const [username, setUsername] = useState(''); const [messages, setMessages] = useState([]); const [inputText, setInputText] = useState(''); const [tempName, setTempName] = useState(''); const scrollRef = useRef(null);
            
            useEffect(() => { const q = db.collection('mets_chat').orderBy('createdAt', 'asc').limitToLast(50); const unsubscribe = q.onSnapshot(snapshot => { setMessages(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); }); return () => unsubscribe(); }, []);
            
            useEffect(() => { 
                if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; 
            }, [messages, isOpen]);

            useEffect(() => {
                if(currentUser) {
                    setUsername(currentUser.displayName || currentUser.email.split('@')[0]);
                } else {
                    const localName = localStorage.getItem('mets_chat_username');
                    if(localName) setUsername(localName);
                }
            }, [currentUser]);

            const handleLogin = (e) => { e.preventDefault(); if (!tempName.trim()) return; setUsername(tempName); localStorage.setItem('mets_chat_username', tempName); };
            const handleSend = async (e) => { 
                e.preventDefault(); 
                if (!inputText.trim()) return; 
                await db.collection('mets_chat').add({ 
                    text: inputText, 
                    sender: username, 
                    uid: currentUser ? currentUser.uid : null,
                    photoURL: currentUser ? currentUser.photoURL : null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp() 
                }); 
                setInputText(''); 
            };
            
            if (!isOpen) return ( <button onClick={() => setIsOpen(true)} className="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-500 text-white p-4 rounded-full shadow-2xl z-50 border-2 border-orange-500 transition-all hover:scale-110"><Icons.MessageSquare className="w-8 h-8" /></button> );
            return ( 
                <div className="fixed bottom-0 right-0 w-full md:w-96 md:bottom-6 md:right-6 bg-slate-900/95 backdrop-blur-xl border-t md:border border-white/10 md:rounded-2xl rounded-t-2xl shadow-2xl z-50 flex flex-col overflow-hidden chat-anim h-[65vh] md:h-[500px]" style={{maxHeight: '100dvh'}}> 
                    <div className="bg-blue-600/20 p-4 flex justify-between items-center border-b border-white/10 cursor-pointer" onClick={() => setIsOpen(false)}> 
                        <div className="flex items-center gap-2"><span className="text-xl">‚öæ</span><span className="font-black text-white">Bullpen Chat</span></div> 
                        <div className="flex gap-2"><button onClick={(e) => { e.stopPropagation(); setIsOpen(false); }}><Icons.Minimize2 className="w-4 h-4 text-slate-300 hover:text-white"/></button><button onClick={(e) => { e.stopPropagation(); setIsOpen(false); }}><Icons.X className="w-4 h-4 text-slate-300 hover:text-white"/></button></div> 
                    </div> 
                    {!username && !currentUser ? ( 
                        <div className="flex-1 flex flex-col items-center justify-center p-6 text-center space-y-4"> 
                            <div className="text-5xl">üèüÔ∏è</div> 
                            <h3 className="text-white font-bold">Enter the Lobby</h3> 
                            <p className="text-slate-400 text-sm">Pick a name to start chatting with the squad.</p> 
                            <form onSubmit={handleLogin} className="w-full space-y-2"><input type="text" placeholder="Your Name..." className="w-full bg-slate-800 border border-white/10 rounded-xl p-3 text-white focus:border-orange-500 outline-none text-center" value={tempName} onChange={e => setTempName(e.target.value)}/><button type="submit" className="w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-2 rounded-xl">Join Chat</button></form> 
                        </div> 
                    ) : ( 
                        <> 
                            <div className="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar" ref={scrollRef}> 
                                {messages.map(msg => ( 
                                    <div key={msg.id} className={`flex items-end gap-2 ${msg.sender === username ? 'flex-row-reverse' : 'flex-row'}`}> 
                                        <UserLink uid={msg.uid} className="shrink-0">
                                            <Avatar src={msg.photoURL} name={msg.sender} className="w-6 h-6 rounded-full object-cover border border-white/10" />
                                        </UserLink>
                                        <div className={`flex flex-col ${msg.sender === username ? 'items-end' : 'items-start'} max-w-[80%]`}> 
                                            <div className="text-[10px] text-slate-500 mb-1 px-1 font-bold">{msg.sender}</div> 
                                            <div className={`px-3 py-2 rounded-xl text-sm break-words ${msg.sender === username ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-slate-800 text-slate-200 rounded-tl-none'}`}>{msg.text}</div> 
                                        </div> 
                                    </div> 
                                ))} 
                            </div> 
                            <form onSubmit={handleSend} className="p-3 bg-black/20 border-t border-white/5 flex gap-2"><input type="text" placeholder="Talk smack..." className="flex-1 bg-slate-800 border border-white/10 rounded-xl px-3 py-2 text-white focus:outline-none focus:border-blue-500 text-sm" value={inputText} onChange={e => setInputText(e.target.value)}/><button type="submit" className="bg-orange-600 hover:bg-orange-500 text-white p-2 rounded-xl"><Icons.Send className="w-4 h-4"/></button></form> 
                        </> 
                    )} 
                </div> 
            );
        };

        const BlogBoard = ({ posts, viewId, currentUser, onAdd, onDelete, onGoogle, onEmail, onSignUp, authError }) => {
            const [newPost, setNewPost] = useState({ title: '', content: '', imageUrl: '', date: new Date().toISOString().split('T')[0] }); 
            const [imageFile, setImageFile] = useState(null); 
            const [isUploading, setIsUploading] = useState(false); 
            const [isFormOpen, setIsFormOpen] = useState(false);
            const [isLoginOpen, setIsLoginOpen] = useState(false); 
            
            const activePost = viewId ? posts.find(p => p.id === viewId) : null;

            useEffect(() => {
                if (activePost) {
                    document.title = `${activePost.title} | MetsSky`;
                } else {
                    document.title = "MetsSky | The Dynasty";
                }
                return () => { document.title = "MetsSky | The Dynasty"; }
            }, [activePost]);

            const handleSubmit = async (e) => { 
                e.preventDefault(); 
                setIsUploading(true);
                let finalImageUrl = newPost.imageUrl;
                if (imageFile) {
                    try {
                        const storageRef = storage.ref(`blog_images/${Date.now()}_${imageFile.name}`);
                        await storageRef.put(imageFile);
                        finalImageUrl = await storageRef.getDownloadURL();
                    } catch (error) {
                        alert("Error uploading image: " + error.message);
                        setIsUploading(false);
                        return;
                    }
                }
                onAdd({ ...newPost, imageUrl: finalImageUrl });
                setNewPost({ title: '', content: '', imageUrl: '', date: new Date().toISOString().split('T')[0] }); 
                setImageFile(null);
                setIsUploading(false);
                setIsFormOpen(false); 
            };

            const handleShare = async () => {
                const shareText = `${activePost.title}\n\nRead more: ${window.location.href}`;
                if (navigator.share) {
                    try { 
                        await navigator.share({ 
                            title: activePost.title,
                            text: shareText,
                            url: window.location.href
                        }); 
                    } catch (err) {}
                } else {
                    navigator.clipboard.writeText(shareText);
                    alert('Headline & Link copied! Paste it into Bluesky.');
                }
            };

            if (viewId) {
                if (!activePost) return <div className="text-center text-slate-500 py-20 animate-pulse">Loading Post or Post Not Found...</div>;
                return (
                    <div className="animate-fade-in pb-10">
                        <button onClick={() => window.location.hash = 'blog'} className="flex items-center gap-2 text-slate-400 hover:text-white mb-6 font-bold text-sm transition-colors"><Icons.ArrowDownCircle className="w-5 h-5 rotate-90" /> Back to Blog</button>
                        <div className="glass-panel rounded-3xl overflow-hidden border border-white/5 shadow-2xl">
                            {activePost.imageUrl && (
                                <div className="h-64 md:h-96 w-full overflow-hidden relative"><img src={activePost.imageUrl} className="w-full h-full object-cover" alt="Blog Header" /><div className="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent to-transparent"></div></div>
                            )}
                            <div className="p-6 md:p-10 relative">
                                <div className="flex justify-between items-start mb-6">
                                    <div className="text-xs font-bold text-purple-400 uppercase tracking-widest flex items-center gap-2"><Icons.Calendar className="w-3 h-3"/> {formatDate(activePost.date)}</div>
                                    <div className="flex gap-4">
                                        <button onClick={handleShare} className="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-xs font-bold transition-colors shadow-lg shadow-blue-600/20">
                                            <Icons.Link className="w-4 h-4"/> Copy Link & Title
                                        </button>
                                    </div>
                                </div>
                                <h1 className="text-3xl md:text-5xl font-black text-white mb-8 leading-tight">{activePost.title || 'Untitled'}</h1>
                                <div className="text-slate-300 leading-relaxed whitespace-pre-wrap font-serif text-lg md:text-xl">{activePost.content || ''}</div>
                                <div className="mt-10 border-t border-white/5 pt-6 text-xs font-bold text-slate-500 uppercase flex items-center gap-3">
                                    <UserLink uid={activePost.authorId}>
                                        <Avatar src={activePost.authorPhoto} name={activePost.authorName} className="w-10 h-10 rounded-full object-cover border border-white/10" />
                                    </UserLink>
                                    <span>Written by {activePost.authorName || 'Contributor'}</span>
                                </div>
                                <CommentsSection postId={activePost.id} currentUser={currentUser} />
                            </div>
                        </div>
                    </div>
                );
            }

            return ( 
                <div className="space-y-8 animate-fade-in"> 
                    <div className="flex justify-between items-center"> 
                        <h3 className="text-2xl font-black text-white italic">MetsSky <span className="text-purple-400">Blog</span></h3> 
                        {currentUser ? ( 
                            <button onClick={() => setIsFormOpen(!isFormOpen)} className="bg-purple-600 hover:bg-purple-500 text-white px-6 py-2 rounded-xl font-bold transition-all shadow-lg flex items-center gap-2"> 
                                {isFormOpen ? <Icons.X className="w-4 h-4"/> : <Icons.Edit2 className="w-4 h-4"/>} {isFormOpen ? 'Close Editor' : 'Write Post'} 
                            </button> 
                        ) : (
                            <button onClick={() => setIsLoginOpen(!isLoginOpen)} className="bg-green-600 hover:bg-green-500 text-white shadow-lg shadow-green-600/20 text-xs font-bold flex items-center gap-2 transition-colors px-6 py-2 rounded-xl">
                                <Icons.Lock className="w-4 h-4"/> Contributor Login
                            </button>
                        )} 
                    </div> 

                    {isLoginOpen && !currentUser && (
                        <div className="mb-8">
                            <AuthGate onGoogle={onGoogle} onEmail={onEmail} onSignUp={onSignUp} error={authError} />
                        </div>
                    )}

                    {isFormOpen && currentUser && ( 
                        <div className="glass-panel p-6 rounded-3xl border border-purple-500/30 mb-8 animate-fade-in"> 
                            <h4 className="text-lg font-bold text-white mb-4">New Blog Post</h4> 
                            <form onSubmit={handleSubmit} className="space-y-4"> 
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4"> 
                                    <div className="space-y-1"> <label className="text-[10px] uppercase font-bold text-slate-500">Headline</label> <input type="text" className="w-full bg-slate-900/50 border border-white/10 rounded-xl p-3 text-white focus:outline-none focus:border-purple-500 font-bold" value={newPost.title} onChange={e => setNewPost({...newPost, title: e.target.value})} required /> </div> 
                                    <div className="space-y-1"> <label className="text-[10px] uppercase font-bold text-slate-500">Date</label> <input type="date" className="w-full bg-slate-900/50 border border-white/10 rounded-xl p-3 text-white focus:outline-none focus:border-purple-500" value={newPost.date} onChange={e => setNewPost({...newPost, date: e.target.value})} required /> </div> 
                                </div> 
                                <div className="space-y-1"> <label className="text-[10px] uppercase font-bold text-slate-500">Header Image</label> <div className="relative"><input type="file" accept="image/*" className="w-full bg-slate-900/50 border border-white/10 rounded-xl p-3 text-white focus:outline-none focus:border-purple-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-purple-600 file:text-white hover:file:bg-purple-500" onChange={(e) => setImageFile(e.target.files[0])} /></div></div> 
                                <div className="space-y-1"> <label className="text-[10px] uppercase font-bold text-slate-500">Content</label> <textarea className="w-full h-48 bg-slate-900/50 border border-white/10 rounded-xl p-3 text-white focus:outline-none focus:border-purple-500" placeholder="Write your article here..." value={newPost.content} onChange={e => setNewPost({...newPost, content: e.target.value})} required></textarea> </div> 
                                <div className="flex justify-end"> <button type="submit" disabled={isUploading} className="bg-purple-600 hover:bg-purple-500 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold px-8 py-3 rounded-xl shadow-lg flex items-center gap-2">{isUploading ? <><span className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span> Uploading...</> : 'Publish Post'}</button> </div> 
                            </form> 
                        </div> 
                    )} 
                    <div className="grid grid-cols-1 gap-4"> 
                        {(posts || []).map(post => ( 
                            <div key={post.id} onClick={() => window.location.hash = `blog/${post.id}`} className="glass-panel p-6 rounded-2xl border border-white/5 hover:border-purple-500/50 hover:bg-white/5 transition-all cursor-pointer group flex gap-6 items-center"> 
                                {post.imageUrl ? (<div className="w-24 h-24 md:w-32 md:h-32 shrink-0 rounded-xl overflow-hidden bg-slate-800"><img src={post.imageUrl} className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" /></div>) : (<div className="w-24 h-24 shrink-0 rounded-xl bg-slate-800 flex items-center justify-center text-purple-900"><Icons.BookOpen className="w-8 h-8 opacity-50" /></div>)}
                                <div className="flex-1 min-w-0">
                                    <div className="text-[10px] font-bold text-purple-400 uppercase tracking-widest mb-2 flex items-center gap-2"> 
                                        {formatDate(post.date)} ‚Ä¢ 
                                        <div className="flex items-center gap-1">
                                            <Avatar src={post.authorPhoto} name={post.authorName} className="w-4 h-4 rounded-full object-cover" />
                                            {post.authorName || 'Staff'}
                                        </div>
                                    </div> 
                                    <h2 className="text-xl md:text-2xl font-black text-white leading-tight group-hover:text-purple-400 transition-colors line-clamp-2 mb-2">{post.title || 'Untitled'}</h2> 
                                    <div className="text-slate-400 text-sm line-clamp-2 leading-relaxed">{post.content}</div>
                                    <div className="mt-3 text-xs font-bold text-slate-500 flex items-center gap-1 group-hover:text-white transition-colors">Read Full Article <Icons.ArrowDownCircle className="w-3 h-3 -rotate-90"/></div>
                                </div> 
                            </div> 
                        ))} 
                        {(!posts || posts.length === 0) && <div className="text-center text-slate-500 py-12 italic">No blog posts yet.</div>} 
                    </div> 
                </div> 
            );
        };

        const PlayerCard = ({ player, onDelete, currentUser }) => ( 
            <div className="glass-panel p-4 rounded-2xl border border-white/10 flex items-center gap-4 relative group"> 
                <div className="w-12 h-12 rounded-full bg-slate-800 flex items-center justify-center text-lg font-black text-white border border-white/10"> {player.name ? player.name[0] : '?'} </div> 
                <div> 
                    <h4 className="font-bold text-white">{player.name}</h4> 
                    <p className="text-xs text-slate-400 italic">"{player.vibe || 'Just chilling'}"</p> 
                </div>
                {currentUser && (
                    <button onClick={() => onDelete(player.id)} className="absolute top-4 right-4 text-slate-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><Icons.Trash2 className="w-4 h-4"/></button>
                )}
            </div> 
        );

        function App() {
            const getRoute = () => {
                const hash = window.location.hash.slice(1);
                if (!hash) return { tab: 'home', id: null };
                
                // Handle routes like #profile/123
                const parts = hash.split('/');
                const baseTab = parts[0];
                
                const validTabs = ['home', 'news', 'blog', 'media', 'schedule', 'roster', 'moves', 'rants', 'links', 'random', 'profile', 'members'];
                const tab = validTabs.includes(baseTab) ? baseTab : 'home';
                
                // If route is #profile/123, id is 123
                return { tab, id: parts[1] || null };
            };
            
            const [route, setRoute] = useState(getRoute());
            const activeTab = route.tab;
            const viewId = route.id; // Can be blog ID or user ID depending on tab

            const [rosterMode, setRosterMode] = useState('40man'); 
            const [scheduleMode, setScheduleMode] = useState('Regular'); 
            const [currentUser, setCurrentUser] = useState(null); 
            const [userProfile, setUserProfile] = useState(null); 
            const [authError, setAuthError] = useState(null);
            const [showHomeLogin, setShowHomeLogin] = useState(false);

            const [schedule2026, setSchedule2026] = useState([]); 
            const [rants, setRants] = useState([]); 
            const [players, setPlayers] = useState([]); 
            const [links, setLinks] = useState([]); 
            const [channels, setChannels] = useState([]); 
            const [news, setNews] = useState([]); 
            const [blogPosts, setBlogPosts] = useState([]);
            const [apiTransactions, setApiTransactions] = useState([]);
            const [randomMets, setRandomMets] = useState([]);
            const [mlbRoster, setMlbRoster] = useState([]);
            
            const [isOnline, setIsOnline] = useState(false); 
            const [loading, setLoading] = useState(true);
            const [newRant, setNewRant] = useState({ topic: '', content: '', mood: 'Neutral' });

            useEffect(() => {
                const onHashChange = () => setRoute(getRoute());
                window.addEventListener('hashchange', onHashChange);
                return () => window.removeEventListener('hashchange', onHashChange);
            }, []);

            useEffect(() => {
                const init = async () => {
                    auth.onAuthStateChanged(user => {
                        setCurrentUser(user || null);
                        if(user) {
                            const userRef = db.collection('users').doc(user.uid);
                            userRef.onSnapshot(doc => {
                                if(doc.exists) {
                                    setUserProfile(doc.data());
                                } else {
                                    userRef.set({
                                        displayName: user.displayName,
                                        email: user.email,
                                        photoURL: user.photoURL,
                                        bio: '',
                                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                    }, { merge: true });
                                }
                            });
                        } else {
                            setUserProfile(null);
                        }
                    });
                    
                    const checkOnline = () => setIsOnline(navigator.onLine); window.addEventListener('online', checkOnline); window.addEventListener('offline', checkOnline); checkOnline();
                    
                    db.collection('mets_schedule_2026').orderBy('date', 'asc').onSnapshot(s => setSchedule2026(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                    db.collection('mets_rants').orderBy('createdAt', 'desc').onSnapshot(s => setRants(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                    db.collection('mets_roster').orderBy('createdAt', 'desc').onSnapshot(s => setPlayers(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                    db.collection('mets_links').orderBy('createdAt', 'desc').onSnapshot(s => setLinks(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                    db.collection('mets_channels').orderBy('createdAt', 'desc').onSnapshot(s => setChannels(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                    db.collection('mets_blog').orderBy('date', 'desc').onSnapshot(s => setBlogPosts(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                    db.collection('mets_random_series').orderBy('date', 'desc').onSnapshot(s => setRandomMets(s.docs.map(d => ({ id: d.id, ...d.data() }))));

                    try {
                        const rosterRes = await fetch('https://statsapi.mlb.com/api/v1/teams/121/roster/40Man');
                        const rosterData = await rosterRes.json();
                        if (rosterData.roster) setMlbRoster(rosterData.roster);
                    } catch (e) { console.error(e); }

                    try {
                        const today = new Date(); const endDate = today.toISOString().split('T')[0];
                        const lastMonth = new Date(); lastMonth.setMonth(lastMonth.getMonth() - 6); const startDate = lastMonth.toISOString().split('T')[0];
                        const res = await fetch(`https://statsapi.mlb.com/api/v1/transactions?teamId=121&startDate=${startDate}&endDate=${endDate}`);
                        const data = await res.json();
                        if(data.transactions) { const sorted = data.transactions.sort((a,b) => new Date(b.date) - new Date(a.date)); setApiTransactions(sorted.slice(0, 50).map(t => ({ date: t.date, description: t.description, player: t.person ? t.person.fullName : null, type: t.typeCode }))); }
                    } catch(e) { console.error(e); }

                    db.collection('mets_news').orderBy('date', 'desc').onSnapshot(async (s) => {
                        const manualNews = s.docs.map(d => ({ id: d.id, ...d.data(), source: 'Manual' }));
                        try {
                            const rssUrls = [ 
                                `https://api.rss2json.com/v1/api.json?rss_url=https://www.mlb.com/mets/feeds/news/rss.xml&t=${Date.now()}`,
                                `https://api.rss2json.com/v1/api.json?rss_url=https://metsmerizedonline.com/feed/&t=${Date.now()}`, 
                                `https://api.rss2json.com/v1/api.json?rss_url=https://risingapple.com/feed/&t=${Date.now()}`,
                                `https://api.rss2json.com/v1/api.json?rss_url=https://www.amazinavenue.com/rss/current&t=${Date.now()}`, 
                                `https://api.rss2json.com/v1/api.json?rss_url=https://nypost.com/sports/mets/feed/&t=${Date.now()}` 
                            ];
                            const responses = await Promise.all(rssUrls.map(url => fetch(url).then(res => res.json()).catch(e=>null)));
                            let liveArticles = [];
                            responses.forEach(feed => { if(feed && feed.status === 'ok' && feed.items) { liveArticles.push(...feed.items.map(i => ({ id: i.guid||i.link, title: i.title, url: i.link, date: i.pubDate || new Date().toISOString(), type: 'Live Feed', source: feed.feed.title }))); } });
                            const combined = [...manualNews, ...liveArticles].sort((a, b) => new Date(b.date) - new Date(a.date));
                            setNews(combined);
                        } catch (err) { setNews(manualNews); }
                    });
                    setLoading(false);
                };
                init();
            }, []);

            const refreshUser = async () => {
                // FIXED REFRESH: Do NOT overwrite the prototype. Just reload auth.
                if (auth.currentUser) {
                    await auth.currentUser.reload();
                    // Force a re-render by creating a new reference, but keep the object valid
                    const user = auth.currentUser;
                    // We simply set it again. The key is that reload() updates the internal data.
                    setCurrentUser(user); 
                    // Force update hack for React to see the change if object ref is same
                    setCurrentUser({...user}); 
                }
            };

            const handleGoogleLogin = async () => { setAuthError(null); try { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); } catch (error) { setAuthError(error.message); } };
            const handleEmailLogin = async (email, password) => { setAuthError(null); try { await auth.signInWithEmailAndPassword(email, password); } catch(error) { setAuthError(error.message); } };
            const handleEmailSignUp = async (email, password, username) => { setAuthError(null); try { const u = await auth.createUserWithEmailAndPassword(email, password); if(username) await u.user.updateProfile({displayName: username}); setCurrentUser({...u.user}); } catch(error) { setAuthError(error.message); } };
            const handleLogout = () => { auth.signOut(); window.location.hash = 'home'; };
            const addRant = async (e) => { e.preventDefault(); if (!currentUser) return; await db.collection('mets_rants').add({ ...newRant, date: new Date().toLocaleDateString(), createdAt: firebase.firestore.FieldValue.serverTimestamp(), authorId: currentUser.uid, authorName: currentUser.displayName || currentUser.email.split('@')[0], authorPhoto: currentUser.photoURL || null }); setNewRant({ topic: '', content: '', mood: 'Neutral' }); };
            const deleteRant = (id) => db.collection('mets_rants').doc(id).delete();
            const addBlogPost = async (data) => { if (!currentUser) return; await db.collection('mets_blog').add({ ...data, authorId: currentUser.uid, authorName: currentUser.displayName || currentUser.email.split('@')[0], authorPhoto: currentUser.photoURL || null, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); };
            const deleteBlogPost = (id) => { if(confirm("Delete?")) db.collection('mets_blog').doc(id).delete(); };
            const addChannel = async (channel) => { if (!currentUser) return; await db.collection('mets_channels').add({ ...channel, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); };
            const deleteChannel = async (id) => { if (!currentUser) return; if(confirm("Delete this link?")) db.collection('mets_channels').doc(id).delete(); };
            const addVibe = async (vibe) => { if (!currentUser) return; await db.collection('mets_roster').add({ ...vibe, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); };
            const deleteVibe = async (id) => { if (!currentUser) return; if(confirm("Delete this vibe?")) db.collection('mets_roster').doc(id).delete(); };
            const addRandomMet = async (item) => { if (!currentUser) return; await db.collection('mets_random_series').add({ ...item, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); };
            const deleteRandomMet = async (id) => { if (!currentUser) return; if(confirm("Delete this entry?")) db.collection('mets_random_series').doc(id).delete(); };

            if (loading) return <div className="min-h-screen flex items-center justify-center text-orange-500 font-black text-2xl bg-slate-900">LOADING CITI FIELD...</div>;

            return (
                <div className="min-h-screen pb-10">
                    <div className="glass-panel sticky top-0 z-50 border-b border-white/10 mb-8">
                        <div className="max-w-5xl mx-auto px-4 md:px-6 h-auto md:h-24 py-4 md:py-0 flex flex-col md:flex-row justify-between items-center gap-4">
                            
                            <div className="flex flex-col md:flex-row md:items-center gap-4 w-full md:w-auto">
                                {/* USER BUTTON (Upper Left) */}
                                {currentUser && (
                                    <button onClick={() => window.location.hash = `profile/${currentUser.uid}`} className="flex items-center gap-2 bg-slate-800 hover:bg-white/10 border border-white/10 px-3 py-1.5 rounded-full transition-all group self-start">
                                        <div className="w-8 h-8 rounded-full overflow-hidden border border-white/20 bg-slate-700 flex items-center justify-center text-xs font-bold text-white">
                                            <Avatar src={currentUser.photoURL} name={currentUser.displayName || 'U'} className="w-full h-full object-cover" />
                                        </div>
                                        <div className="text-left">
                                            <div className="text-[10px] text-slate-400 font-bold uppercase tracking-widest leading-none mb-0.5">My Account</div>
                                            <div className="text-xs font-bold text-white leading-none group-hover:text-blue-400 transition-colors">Edit Profile</div>
                                        </div>
                                    </button>
                                )}
                                
                                <div className="flex items-center gap-4 group cursor-pointer" onClick={() => window.location.hash = 'home'}>
                                    <div className="bg-gradient-to-br from-orange-500 to-red-600 p-2 md:p-3 rounded-2xl shadow-lg shadow-orange-500/30 group-hover:scale-110 transition-transform"><span className="text-2xl md:text-3xl">‚öæ</span></div>
                                    <div><h1 className="text-2xl md:text-3xl font-black text-white tracking-tight italic">Mets<span className="text-blue-500">Sky</span></h1><p className="text-[10px] md:text-xs font-bold text-slate-400 uppercase tracking-[0.2em]">The New York Frame of Mind</p></div>
                                </div>
                            </div>

                            <div className="w-full md:w-auto flex gap-2 bg-black/20 p-1.5 rounded-xl border border-white/5 overflow-x-auto custom-scrollbar">
                                {['home', 'members', 'news', 'blog', 'media', 'schedule', 'roster', 'moves', 'rants', 'links', 'random'].map(tab => (
                                    <button key={tab} onClick={() => window.location.hash = tab} className={`px-3 md:px-5 py-2 md:py-2.5 rounded-lg font-bold text-xs md:text-sm whitespace-nowrap transition-all flex items-center gap-2 ${activeTab === tab ? (tab === 'social' ? 'bg-sky-600' : tab === 'blog' ? 'bg-purple-600' : tab === 'random' ? 'bg-pink-600' : 'bg-blue-600') + ' text-white shadow-lg' : 'text-slate-400 hover:text-white hover:bg-white/5'}`}>
                                         {tab === 'random' ? 'Series' : tab.charAt(0).toUpperCase() + tab.slice(1)}
                                    </button>
                                ))}
                                <div className="ml-4 flex items-center gap-2 text-[10px] font-bold text-slate-500 uppercase tracking-widest border-l border-slate-700 pl-4 whitespace-nowrap"><div className={`w-2 h-2 rounded-full ${isOnline ? 'bg-green-500 pulse-dot' : 'bg-red-500'}`}></div>{isOnline ? "LIVE" : "OFFLINE"}</div>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-5xl mx-auto px-6">
                        {activeTab === 'home' && (
                            <div className="animate-fade-in space-y-6">
                                <CountdownTicket />
                                
                                <div className="flex justify-end">
                                    {currentUser ? (
                                        <div className="glass-panel px-4 py-2 rounded-xl flex items-center gap-3">
                                            <div className="text-sm font-bold text-white">Welcome back, {currentUser.displayName || 'Fan'}</div>
                                        </div>
                                    ) : (
                                        <button onClick={() => setShowHomeLogin(!showHomeLogin)} className="bg-slate-800 hover:bg-white/10 text-white font-bold py-2 px-6 rounded-xl border border-white/10 shadow-lg flex items-center gap-2 transition-colors">
                                            <Icons.Lock className="w-4 h-4 text-orange-500"/> {showHomeLogin ? 'Close' : 'Member Access'}
                                        </button>
                                    )}
                                </div>
                                {showHomeLogin && !currentUser && (
                                    <div className="animate-fade-in">
                                        <AuthGate onGoogle={handleGoogleLogin} onEmail={handleEmailLogin} onSignUp={handleEmailSignUp} error={authError} />
                                    </div>
                                )}
                                
                                <a href="https://www.qflea.com/LGM.html" target="_blank" className="block w-full glass-panel p-8 rounded-3xl text-center border-2 border-orange-500/50 hover:border-orange-400 hover:bg-white/5 transition-all group shadow-2xl shadow-orange-900/20 mb-8 relative overflow-hidden">
                                    <div className="absolute inset-0 bg-gradient-to-r from-orange-600/10 to-blue-600/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                    <div className="relative z-10">
                                        <h2 className="text-3xl md:text-5xl font-black text-white italic tracking-tighter mb-2 group-hover:scale-105 transition-transform">
                                            METSSKY RESOURCE PAGE
                                        </h2>
                                        <div className="flex items-center justify-center gap-2 text-blue-400 font-bold uppercase tracking-widest text-sm md:text-base">
                                            <Icons.Link className="w-5 h-5" /> Click to Visit
                                        </div>
                                    </div>
                                </a>

                                <FeaturedVideo />

                                <div className="relative h-96 rounded-3xl overflow-hidden flex items-center justify-center bg-gradient-to-br from-blue-900 to-slate-900 border border-white/10 shadow-2xl group mt-8">
                                    <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-20"></div>
                                    <div className="absolute top-0 left-0 w-full h-full bg-gradient-to-b from-transparent via-blue-900/20 to-slate-900/90"></div>
                                    <div className="relative z-10 text-center px-4"><h1 className="text-6xl md:text-9xl font-black text-white tracking-tighter drop-shadow-2xl scale-95 group-hover:scale-100 transition-transform duration-500">LET'S GO <span className="text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-red-500 text-glow">METS</span></h1></div>
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
                                     <button onClick={() => window.location.hash = 'random'} className="glass-panel p-6 rounded-3xl text-center hover:bg-white/5 transition-all group flex flex-col items-center justify-center gap-3 h-48 border border-white/10 hover:border-pink-500/50 md:col-span-2">
                                        <div className="p-4 bg-pink-500/20 rounded-2xl group-hover:scale-110 transition-transform shadow-lg shadow-pink-500/20"><Icons.Shuffle className="w-8 h-8 text-pink-400"/></div>
                                        <div className="font-black text-white text-2xl uppercase tracking-wide">Random Met Series</div>
                                     </button>
                                     <a href="https://bsky.app/hashtag/MetsSky" target="_blank" className="glass-panel p-6 rounded-3xl text-center hover:bg-white/5 transition-all group flex flex-col items-center justify-center gap-3 h-48 border border-white/10 hover:border-sky-500/50 md:col-span-2">
                                        <div className="p-4 bg-sky-600 text-white rounded-2xl group-hover:scale-110 transition-transform shadow-lg shadow-sky-500/20 flex gap-2"><Icons.Cloud className="w-8 h-8"/></div><div className="font-black text-white text-2xl uppercase tracking-wide">#MetsSky</div>
                                    </a>
                                    <button onClick={() => window.location.hash = 'news'} className="glass-panel p-6 rounded-3xl text-center hover:bg-white/5 transition-all group flex flex-col items-center justify-center gap-3 h-48 border border-white/10 hover:border-sky-500/50 md:col-span-2">
                                        <div className="p-4 bg-sky-600 text-white rounded-2xl group-hover:scale-110 transition-transform shadow-lg shadow-sky-500/20 flex gap-2"><Icons.Newspaper className="w-8 h-8"/></div><div className="font-black text-white text-2xl uppercase tracking-wide">News Wire</div>
                                    </button>
                                    <button onClick={() => window.location.hash = 'blog'} className="glass-panel p-6 rounded-3xl text-center hover:bg-white/5 transition-all group flex flex-col items-center justify-center gap-3 h-48 border border-white/10 hover:border-purple-500/50 md:col-span-2">
                                        <div className="p-4 bg-purple-500/20 rounded-2xl group-hover:scale-110 transition-transform shadow-lg shadow-purple-500/20"><Icons.BookOpen className="w-8 h-8 text-purple-400"/></div><div className="font-black text-white text-2xl uppercase tracking-wide">MetsSky Blog</div>
                                    </button>
                                    <button onClick={() => window.location.hash = 'media'} className="glass-panel p-6 rounded-3xl text-center hover:bg-white/5 transition-all group flex flex-col items-center justify-center gap-3 h-48 border border-white/10 hover:border-yellow-500/50">
                                        <div className="p-4 bg-yellow-500/20 rounded-2xl group-hover:scale-110 transition-transform"><Icons.Tv className="w-8 h-8 text-yellow-400"/></div><div className="font-black text-white text-lg uppercase tracking-wide">Media</div>
                                    </button>
                                    <button onClick={() => window.location.hash = 'schedule'} className="glass-panel p-6 rounded-3xl text-center hover:bg-white/5 transition-all group flex flex-col items-center justify-center gap-3 h-48 border border-white/10 hover:border-blue-500/50">
                                        <div className="p-4 bg-blue-500/20 rounded-2xl group-hover:scale-110 transition-transform"><Icons.Calendar className="w-8 h-8 text-blue-400"/></div><div className="font-black text-white text-lg uppercase tracking-wide">Season Log</div>
                                    </button>
                                    <button onClick={() => window.location.hash = 'roster'} className="glass-panel p-6 rounded-3xl text-center hover:bg-white/5 transition-all group flex flex-col items-center justify-center gap-3 h-48 border border-white/10 hover:border-orange-500/50">
                                        <div className="p-4 bg-orange-500/20 rounded-2xl group-hover:scale-110 transition-transform"><Icons.Users className="w-8 h-8 text-orange-400"/></div><div className="font-black text-white text-lg uppercase tracking-wide">Roster</div>
                                    </button>
                                    <button onClick={() => window.location.hash = 'moves'} className="glass-panel p-6 rounded-3xl text-center hover:bg-white/5 transition-all group flex flex-col items-center justify-center gap-3 h-48 border border-white/10 hover:border-green-500/50">
                                        <div className="p-4 bg-green-500/20 rounded-2xl group-hover:scale-110 transition-transform"><Icons.RefreshCw className="w-8 h-8 text-green-400"/></div><div className="font-black text-white text-lg uppercase tracking-wide">Transactions</div>
                                    </button>
                                    <button onClick={() => window.location.hash = 'rants'} className="glass-panel p-6 rounded-3xl text-center hover:bg-white/5 transition-all group flex flex-col items-center justify-center gap-3 h-48 border border-white/10 hover:border-red-500/50">
                                        <div className="p-4 bg-red-500/20 rounded-2xl group-hover:scale-110 transition-transform shadow-lg shadow-red-500/20"><Icons.MessageSquare className="w-8 h-8 text-red-400"/></div><div className="font-black text-white text-lg uppercase tracking-wide">Fan Zone</div>
                                    </button>
                                    <button onClick={() => window.location.hash = 'links'} className="glass-panel p-6 rounded-3xl text-center hover:bg-white/5 transition-all group flex flex-col items-center justify-center gap-3 h-48 border border-white/10 hover:border-cyan-500/50">
                                        <div className="p-4 bg-cyan-500/20 rounded-2xl group-hover:scale-110 transition-transform"><Icons.Link className="w-8 h-8 text-cyan-400"/></div><div className="font-black text-white text-lg uppercase tracking-wide">Receipts</div>
                                    </button>
                                </div>
                            </div>
                        )}

                        {activeTab === 'profile' && (
                            currentUser ? (
                                <ProfileBoard currentUser={currentUser} viewUserId={viewId} onUpdateProfile={refreshUser} onLogout={handleLogout} />
                            ) : (
                                <div className="text-center">
                                    <AuthGate onGoogle={handleGoogleLogin} onEmail={handleEmailLogin} onSignUp={handleEmailSignUp} error={authError} />
                                </div>
                            )
                        )}

                        {activeTab === 'members' && <MembersBoard />}

                        {activeTab === 'news' && <NewsBoard news={news} />}
                        
                        {activeTab === 'blog' && (
                            <BlogBoard 
                                posts={blogPosts} 
                                viewId={viewId} 
                                currentUser={currentUser} 
                                onAdd={addBlogPost} 
                                onDelete={deleteBlogPost} 
                                onGoogle={handleGoogleLogin}
                                onEmail={handleEmailLogin}
                                onSignUp={handleEmailSignUp}
                                authError={authError}
                            />
                        )}

                        {activeTab === 'media' && <MediaBoard channels={channels} currentUser={currentUser} onAdd={addChannel} onDelete={deleteChannel} />}
                        
                        {activeTab === 'schedule' && (
                            <div className="space-y-8 animate-fade-in">
                                 <div className="flex flex-wrap items-center gap-4 mb-4">
                                    <h2 className="text-2xl font-black text-white">Season Log</h2>
                                    <div className="flex bg-slate-900/50 p-1 rounded-xl border border-white/10">
                                        <button onClick={() => setScheduleMode('Regular')} className={`px-4 py-1 text-xs font-bold rounded-lg transition-all ${scheduleMode === 'Regular' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:text-white'}`}>Regular</button>
                                        <button onClick={() => setScheduleMode('Spring')} className={`px-4 py-1 text-xs font-bold rounded-lg transition-all ${scheduleMode === 'Spring' ? 'bg-yellow-600 text-white' : 'text-slate-400 hover:text-white'}`}>Spring</button>
                                    </div>
                                 </div>
                                 <div className="grid gap-3">
                                     {(schedule2026 || []).filter(g => (g.gameType || 'Regular') === scheduleMode).map(game => (<ScheduleCard key={game.id} game={game} />))}
                                     {(!schedule2026 || schedule2026.length === 0) && <div className="text-center text-slate-500">No games found.</div>}
                                 </div>
                            </div>
                        )}
                        
                        {activeTab === 'roster' && (
                            <RosterBoard 
                                mlbRoster={mlbRoster} 
                                players={players} 
                                rosterMode={rosterMode} 
                                setRosterMode={setRosterMode}
                                currentUser={currentUser}
                                onAddVibe={addVibe}
                                onDeleteVibe={deleteVibe}
                            />
                        )}
                        
                        {activeTab === 'moves' && <MovesBoard transactions={apiTransactions} />}
                        
                        {activeTab === 'rants' && (
                            <div className="space-y-8 animate-fade-in">
                                <div className="glass-panel p-6 rounded-3xl border border-orange-500/30">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="text-lg font-black text-white">Fan Zone Message Board</h3>
                                        {currentUser && <button onClick={handleLogout} className="text-xs text-red-400 flex items-center gap-2 hover:text-red-300"><Icons.LogOut className="w-4 h-4"/> Sign Out</button>}
                                    </div>
                                    {!currentUser ? (<AuthGate onGoogle={handleGoogleLogin} onEmail={handleEmailLogin} onSignUp={handleEmailSignUp} error={authError} />) : (
                                        <form onSubmit={addRant} className="flex flex-col gap-4">
                                            <div className="flex items-center gap-2 mb-2">
                                                {currentUser.photoURL ? (<img src={currentUser.photoURL} className="w-8 h-8 rounded-full border border-white/20"/>) : (<div className="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center font-bold text-white text-xs">{(currentUser.displayName && currentUser.displayName[0]) ? currentUser.displayName[0] : (currentUser.email && currentUser.email[0] ? currentUser.email[0].toUpperCase() : 'U')}</div>)}
                                                <span className="text-sm text-slate-400">Posting as <strong className="text-white">{currentUser.displayName || (currentUser.email && currentUser.email.split('@')[0]) || 'User'}</strong></span>
                                            </div>
                                            <div className="flex flex-col md:flex-row gap-4">
                                                <input type="text" placeholder="Topic" className="bg-slate-900/50 border border-white/10 rounded-xl p-3 text-white flex-1 focus:outline-none focus:border-orange-500" value={newRant.topic} onChange={e => setNewRant({...newRant, topic: e.target.value})} required />
                                                <select className="bg-slate-900/50 border border-white/10 rounded-xl p-3 text-white w-full md:w-auto focus:outline-none focus:border-orange-500" value={newRant.mood} onChange={e => setNewRant({...newRant, mood: e.target.value})}><option value="Neutral">Neutral</option><option value="Happy">Happy</option><option value="Angry">Angry</option></select>
                                            </div>
                                            <textarea placeholder="Let it all out..." className="bg-slate-900/50 border border-white/10 rounded-xl p-3 text-white h-32 focus:outline-none focus:border-orange-500" value={newRant.content} onChange={e => setNewRant({...newRant, content: e.target.value})} required />
                                            <button type="submit" className="w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-3 rounded-xl shadow-lg">Post Rant</button>
                                        </form>
                                    )}
                                </div>
                                <div className="grid gap-4">
                                    {rants.map(rant => (<RantCard key={rant.id} rant={rant} currentUser={currentUser} onDelete={deleteRant} />))}
                                    {rants.length === 0 && <div className="text-center text-slate-500 py-12">No rants yet. Be the first!</div>}
                                </div>
                            </div>
                        )}
                        {activeTab === 'links' && <LinksBoard links={links} />}
                        
                        {activeTab === 'random' && <RandomSeriesBoard entries={randomMets} currentUser={currentUser} onAdd={addRandomMet} onDelete={deleteRandomMet} />}
                    </div>
                    <ChatBox currentUser={currentUser} />
                    <HomeFloatingButton />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(reg => console.log('MetsSky SW Registered'))
                    .catch(err => console.log('SW Registration Failed: ', err));
            });
        }
    </script>
</body>
</html>
